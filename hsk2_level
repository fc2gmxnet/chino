import streamlit as st
import pandas as pd
import random
import os

# --- FILE CONFIGURATION ---
# The name of your Excel file
EXCEL_FILE = 'hsk2_data.xlsx'

# Function to load data or create it if it doesn't exist
def load_data():
    if os.path.exists(EXCEL_FILE):
        return pd.read_excel(EXCEL_FILE)
    else:
        # If file doesn't exist, create it using your initial data
        initial_data = {
            'Column1': ['çˆ·çˆ·å¸¸å¸¸è®©æˆ‘ç»™ä»–è¯»æŠ¥çº¸', 'è¿™ä¸ªæ¶ˆæ¯æ˜¯æˆ‘ä»æŠ¥çº¸ä¸Šçœ‹åˆ°çš„', 'è€ƒè¯•çš„æ—¶å€™ä¸å¯ä»¥ä½¿ç”¨é“…ç¬”'], # ... add your full list here
            'Column2': ['YÃ©ye chÃ¡ngchÃ¡ng rÃ ng wÇ’ gÄ›i tÄ dÃº bÃ ozhÇ', 'zhÃ¨ ge xiÄoxi shÃ¬ wÇ’ cÃ³ng bÃ ozhÇ shang kÃ n dÃ o de', 'kÇoshÃ¬ de shÃ­hou bÃ¹ kÄ›yÇ shÇyÃ²ng qiÄnbÇ'],
            'Column3': ['My grandfather often lets me read the newspaper for him', 'I read this news in the paper', 'Pencil is not allowed'],
            'level': ['normal'] * 3 # Default level for new items
        }
        df_new = pd.DataFrame(initial_data)
        df_new.to_excel(EXCEL_FILE, index=False)
        return df_new

# Function to save a specific level update
def save_level(index, new_level):
    df = pd.read_excel(EXCEL_FILE)
    df.at[index, 'level'] = new_level
    df.to_excel(EXCEL_FILE, index=False)
    st.success(f"Saved as {new_level}!")

# --- APP SETUP ---
st.set_page_config(page_title='HSK Study Tool', layout='wide')

df = load_data()

# Ensure "level" column exists
if 'level' not in df.columns:
    df['level'] = 'normal'

# Toggle Language
toggle = st.toggle("HSK 2: ç”¨ä¸­æ–‡å›ç­”")
col_q, col_a = (2, 0) if toggle else (0, 2)

# --- SESSION STATE ---
if "random_index" not in st.session_state:
    st.session_state.random_index = random.randint(0, len(df) - 1)

def get_new_random_row():
    st.session_state.random_index = random.randint(0, len(df) - 1)
    # Clear "revealed" state when moving to a new card
    st.session_state.revealed = False

if "revealed" not in st.session_state:
    st.session_state.revealed = False

# --- UI DISPLAY ---
random_row = df.iloc[st.session_state.random_index]

# Display Question
if col_q == 0:
    st.title(random_row['Column1'])
else:
    st.subheader(random_row['Column3'])

# Difficulty Selector (Sets the "level" for this specific card)
current_level = random_row['level']
level_options = ["easy", "normal", "difficult"]
new_choice = st.selectbox(
    "Set Difficulty Level:", 
    level_options, 
    index=level_options.index(current_level) if current_level in level_options else 1
)

# Save button for the level
if st.button("ğŸ’¾ Save Level"):
    save_level(st.session_state.random_index, new_choice)

st.divider()

# Reveal Logic
if st.button('??? (Reveal Answer)'):
    st.session_state.revealed = True

if st.session_state.revealed:
    st.write(f"**Pinyin:** {random_row['Column2']}")
    if col_a == 0:
        st.title(random_row['Column1'])
    else:
        st.subheader(random_row['Column3'])

st.divider()

# Navigation
if st.button("+++ (Next Card)"):
    get_new_random_row()
    st.rerun()

# Optional: Show a small stats table
with st.expander("View Progress Statistics"):
    st.table(df['level'].value_counts())
